import{r as j,d as v,o as U,n as k,j as t,M as F,q as I,t as S,w as O}from"./prerender-BIIx8aII.js";import{u as D,r as m}from"./vendor-BsMbSbDn.js";function G(c){const i=Math.floor(c/1e3),l=Math.floor(i/60),f=i%60;return l>0?`${l}m ${f.toString().padStart(2,"0")}s`:`${f}s`}function V({isOpen:c,onRequestClose:i,adminMode:l=!1}){const f=D(),[u,R]=m.useState([]),[d,b]=m.useState(!1),[y,P]=m.useState(!1),[w,$]=m.useState(Date.now());m.useEffect(()=>{if(!c)return;const n=setInterval(()=>$(Date.now()),1e3);return()=>clearInterval(n)},[c]),m.useEffect(()=>{if(!c)return;b(!0);const n=j(v,"multiplayer"),e=U(n,s=>{const p=s.val()||{},h=Object.entries(p).map(([o,a])=>({code:o,data:a})).filter(({data:o})=>{if(!o)return!1;const a=o.status||"waiting";if(l)return a==="waiting"||a==="playing";if(o.isPublic!==!0||a!=="waiting")return!1;const r=o.players||null,x=r?Object.keys(r).length:0,g=Number.isFinite(o.maxPlayers)?o.maxPlayers:2;return!(x>=g)}).sort((o,a)=>{const r=o.data.createdAt||0;return(a.data.createdAt||0)-r});R(h),b(!1)},()=>{R([]),b(!1)});return()=>{k(n),typeof e=="function"&&e()}},[c,l]);const C=n=>{const{code:e,data:s}=n;if(!e)return;const p=Array.isArray(s.solutions)&&s.solutions.length>0?s.solutions.length:(s.solution,1),h=!!s.speedrun,o=Number.isFinite(s.maxPlayers)?s.maxPlayers:void 0,a=s.isPublic===!0,r=["mode=multiplayer",`code=${e}`,`speedrun=${h}`,`boards=${p}`];o&&r.push(`maxPlayers=${o}`),r.push(`isPublic=${a}`),i==null||i(),f(`/game?${r.join("&")}`)},L=async n=>{if(!(!n||!I.currentUser))try{await S(j(v,`multiplayer/${n}`))}catch{}},E=async()=>{if(!l||y||d||!I.currentUser)return;const e=u.map(({code:s})=>s).filter(Boolean);if(e.length!==0){P(!0);try{await Promise.all(e.map(s=>S(j(v,`multiplayer/${s}`))))}catch{}finally{P(!1)}}};return t.jsx(F,{isOpen:c,onRequestClose:i,children:t.jsxs("div",{className:"openRoomsModalRoot",children:[t.jsx("h2",{className:"openRoomsTitle",children:"Open Rooms"}),d?t.jsx("div",{className:"openRoomsStatus openRoomsStatusLoading",children:"Loading rooms..."}):u.length===0?t.jsx("div",{className:"openRoomsStatus openRoomsStatusEmpty",children:l?"There are no active rooms right now.":"There are no public rooms available right now."}):t.jsx("div",{className:"openRoomsList",children:u.map(({code:n,data:e})=>{const s=e.players||null,p=s?Object.keys(s).length:0,h=Number.isFinite(e.maxPlayers)?e.maxPlayers:2,o=Array.isArray(e.solutions)&&e.solutions.length>0?e.solutions.length:(e.solution,1),a=!!e.speedrun,r=s?Object.values(s).find(M=>M&&M.isHost):null,x=(r==null?void 0:r.name)||"Host",g=e.roomName||`${x}'s room`,N=typeof e.createdAt=="number"?e.createdAt:null,T=N?Math.max(0,w-N):null,A=N?Math.max(0,O-T):null,B=A!=null?G(A):null;return t.jsxs("div",{className:"openRoomsItem",children:[t.jsxs("div",{className:"openRoomsItemMain",children:[t.jsx("div",{className:"openRoomsItemTitle",children:g}),t.jsxs("div",{className:"openRoomsItemMeta",children:[p,"/",h," players · ",o," board",o>1?"s":""," · ",a?"Speedrun":"Standard"]}),B&&t.jsxs("div",{className:"openRoomsItemExpires",children:["Expires in ",B]})]}),t.jsxs("div",{className:"openRoomsItemActions",children:[l&&t.jsx("button",{type:"button",onClick:()=>L(n),className:"homeBtn homeBtnOutline openRoomsItemButton",children:"Close"}),!l&&t.jsx("button",{type:"button",onClick:()=>C({code:n,data:e}),className:"homeBtn homeBtnGreen openRoomsItemButton",children:"Join"})]})]},n)})}),t.jsxs("div",{className:"openRoomsFooter",children:[l&&t.jsx("button",{type:"button",onClick:E,disabled:y||d||u.length===0,className:"homeBtn homeBtnOutline homeBtnLg openRoomsFooterButton",style:{opacity:y||d||u.length===0?.7:1},children:y?"Closing rooms...":"Close all rooms"}),t.jsx("button",{type:"button",onClick:i,className:"homeBtn homeBtnGreen homeBtnLg openRoomsFooterButton",children:"Close"})]})]})})}export{V as default};